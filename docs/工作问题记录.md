### 工作问题记录

#### 1. 扫码后向客户端发送数据

**流程**

1. 扫码注册后会获取到用户的注册信息，将该信息通过子线程插入到`room`数据库中
2. 如果插入成功，就向客户端发送消息：`done!`

**问题**

1. 一开始，通过`writeCharacteristic`发送数据不成功，获取到的数据都是空的，以为是在子线程里发送数据不对
2. 后改到主线程，客户端依旧闪退
3. 后来又想，是蓝牙类的单例出了问题？但是单例没写错
4. 又想或者是发送数据的方式不对，因为这个代码原本的被动在回调中通过`.notifyCharacteristicChanged()`发送数据是成功的
5. 于是用了上面这种方法，还是闪退
6. 然后经过网上的一番查找，发现了一个通过点击按钮发送数据的方式
7. 试了试，这样是成功的，这让我们确定不是参数、或者回调中发送数据关系
8. 于是，我把数据库插入返回的值，作为一个`LiveData`来监控，当这个数据发生变化时，通知`Observer`去调用发送数据的代码
9. 这依旧没有成功，但这个操作是最终正确代码的一部分
10. 后来，我下载了最初始的代码，运行。发现原版的项目在扫码后就会导致蓝牙断开、客户端闪退，并不是我函数用错了。这时终于明白，蓝牙自动断开了，自然发送不了数据了。
11. 于是又继续看了看源码，发现原本代码中，蓝牙的开启和关闭是绑定在`MainActivity`的启动和销毁中的。好家伙，那当`MainActivity`切换到相机的`Activity`，可不就自动销毁了蓝牙。

**解决方法**

1. 将数据库插入的返回值作为`LiveData`监控，当它变化且不为0时，进行数据的发送
2. 创建一个`Service`类，将蓝牙的开启与关闭和它绑定，这样`Activity`不管怎么切换，都不会影响蓝牙的开关了。
3. `Service`的启动放在`Activity`启动和开启相机的时候，在成功发送完数据后关闭`Service`



#### 2. uuid修改不成功

**问题**

修改了`uuid`，发出去后却还是旧的

**解决方法**

粗心，源项目在开启服务前就使用了`uuid`，等到服务开启后直接发出去包含该`uuid`的数据。而我是在服务开启时才修改这个值。应当仔细理解源码，明确广播前是否成功修改了`uuid`。



#### 3. 多设备蓝牙配对问题1

**问题**

有好几个手机、电脑同事扫码注册/登录时，如何保证准确连接上自己的设备？

**解决方法**

1. 由电脑端在生成的二维码中放入一个随机`uuid`，在手机端扫码后保存好这个`uuid`。

2. 手机端使用该`uuid`开启蓝牙服务，再由电脑端去连接。

这样就能保证电脑和手机蓝牙连接的时候，`uuid`是一一对应的了。



#### 4. 多设备蓝牙配对问题2

**问题**

由问题1又产生了新的问题，如果一个人同时有好几个设备，每个设备在注册前都随机生成了一个`uuid`。那么在登录时，手机端应当使用哪个`uuid`进行蓝牙广播？

**解决思路**

1. 可以全部进行广播吗？如果可以，是否应当记录当前连接服务的`uuid`。
2. 让用户点击账号，通过该账号的点击来发布对应的`uuid`服务。但是用户得知道登录前要点击登录的设备。
3. 两层嵌套的方式，客户端先用默认的uuid发送一个登录请求，这个请求中包含它自己的uuid，服务端查询表项中有没有这个uuid，有的话就直接连接，没有就丢弃。妙啊。